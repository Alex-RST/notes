# 第11章 后端编译与优化
## 11.2 即时编译器
目前主流的Java虚拟机（HotSpot、OpenJ9），Java程序最初都是通过解释器（Interpreter）解释执行，当发现一段代码运行频繁，在运行时会将这些代码编译为本地机器码。运行时完成这个任务的后端编译器成为**即时编译器**。

HotSpot虚拟机内置了两个（或三个）即时编译器，可以通过“-client”或“-server”参数强制指定在那种模式下运行：
- 客户端编译器（Client Compiler）或者简称C1编译器。“-client”。
- 服务端编译器（Server Compiler）或者简称C2编译器。“-server”。

解释器与编译器使用方式有三种：（可以使用“-version”参数显示模式）
- 混合模式
- 解释模式：使用“-Xint”参数强制进入“解释模式”。编译器完全不介入，所有代码都解释执行。
- 编译模式：使用“-Xcomp”参数强制进入“编译模式”。将优先采用编译执行，解释器在编译无法进行的情况下介入。

在运行过程中会被即时编译器编译的目标成为“热点代码”，主要有两类：
- 被多次调用的方法。
- 被多次执行的循环体。

热点代码探测判定方式，主要有两种：
- **基于采样的热点探测**。虚拟机周期性的检查各个线程调用栈顶。将经常出现在栈顶的方法认定为“热点方法”。
- **基于计数器的热点探测**。虚拟机为每个方法（甚至代码块）建立计数器，当超过阈值则认定为“热点方法”。

&emsp;&emsp;为了实现基于计数的热点探测，HotSpot为每个方法准备了两类计数器：**方法调用计数器**（Invocation Counter）、**回边计数器**（Back Edge Counter）。  两个计数器都有明确阈值，当阈值溢出，触发即时编译。

&emsp;&emsp;**方法调用计数器**。统计方法被调用的次数。可通过“**-XX:CompileThreshold**”设定。当方法被调用时，虚拟机会检查该方法是否存在被即时编译过的版本，如果存在，则优先使用编译后的代码。如果不存在，则将方法调用计数器值加一，然后判断方法调用计数器与回边计数器值之和是否超过方法调用计数器阈值。一旦超过阈值，将会向即时编译器提交一个该方法的代码编译请求。

&emsp;&emsp;**回边计数器**。作用是统计方法中循环体现代码执行的次数，在字节码中遇到控制流向后跳转的指令就称为“回边（Back Edge）”。

## 11.3 提前编译器
提前编译有两条明细分支：
1. 在程序运行之前把程序代码编译成机器码的静态编译工作（传统C/C++编译方式）。
2. 在原本即时编译器在运行时要做的编译工作提前做好并保存下来。
